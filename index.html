<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Подача показаний счётчиков | ARTSTUDIO Nevsky</title>
    <style>
        /* Аналогично предыдущему: Circe fonts, base styles, modal, form sections */
        @font-face { font-family: 'Circe'; src: url('./fonts/circe.woff2') format('woff2'); font-weight: 400; }
        body { font-family: 'Circe', sans-serif; margin: 0; padding: 1rem; background: #fff; color: #262d36; }
        header { text-align: center; margin-bottom: 2rem; }
        main { max-width: 600px; margin: 0 auto; background: #fff; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .form-section { margin-bottom: 1.5rem; }
        .form-section h2 { font-size: 1.5rem; font-weight: 400; margin: 0 0 0.5rem; }
        input[type="number"], button { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 0.5rem; font: 1rem 'Circe', sans-serif; box-sizing: border-box; }
        button { background: #c49a5f; color: #fff; font-weight: 700; border: none; cursor: pointer; }
        button:hover { background: #a47f48; }
        input[type="file"] { margin-top: 0.5rem; }
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        #modal-window { background: #fff; padding: 2rem; border-radius: 1.5rem; max-width: 90%; max-height: 80vh; overflow-y: auto; text-align: center; }
        .meter-row { display: flex; flex-direction: column; margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem; }
        .meter-info { font-weight: 600; margin-bottom: 0.5rem; }
        .photo-upload { margin-top: 0.5rem; }
        @media (max-width: 600px) { main { padding: 1rem; } input, button { padding: 0.5rem; font-size: 0.95rem; } }
    </style>
</head>
<body>
    <header>
        <h1>Подача показаний счётчиков</h1>
    </header>
    <main>
        <!-- Шаг 1: Ввод номера апартамента -->
        <div id="apt-step">
            <div class="form-section">
                <h2>Введите номер апартамента</h2>
                <input type="number" id="apt-number" placeholder="Например, 246" min="1" required>
                <button onclick="loadMeters()">Загрузить счётчики</button>
            </div>
        </div>

        <!-- Шаг 2: Ввод показаний -->
        <div id="meters-step" style="display: none;">
            <h2 id="apt-title">Апартамент №</h2>
            <form id="readings-form">
                <div id="meters-container"></div>
                <button type="button" onclick="confirmSubmission()">Отправить показания</button>
            </form>
        </div>
    </main>

    <!-- Модалка дубликатов -->
    <div id="duplicate-modal" class="modal-overlay" style="display: none;">
        <div id="modal-window">
            <p>По апартаменту показания уже поданы за период. Показать текущие?</p>
            <button onclick="loadExistingReadings()">Скорректировать</button>
            <button onclick="cancelApartment()">Отмена</button>
        </div>
    </div>

    <!-- Модалка подтверждения -->
    <div id="confirm-modal" class="modal-overlay" style="display: none;">
        <div id="modal-window">
            <p id="confirm-text"></p>
            <button onclick="submitReadings()">Подтвердить</button>
            <button onclick="closeConfirm()">Отмена</button>
        </div>
    </div>

    <!-- Модалка ошибки/успеха -->
    <div id="alert-modal" class="modal-overlay" style="display: none;">
        <div id="modal-window">
            <p id="alert-text"></p>
            <button onclick="closeAlert()">OK</button>
        </div>
    </div>

    <script>
        let currentApt = '';
        let meters = [];
        let readings = {}; // { 'type_number': value }
        let photos = {}; // { 'type_number': file }
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz4AQtfnOxx9f-9DVJDfRp7JW-zwBeAcVxBBjUT0rPguKHdcfEj9bCy0hH1P5cfRWhZ6g/exec'; // Замените на ID вашего Apps Script

        function loadMeters() {
            currentApt = document.getElementById('apt-number').value.trim();
            if (!currentApt) return showAlert('Введите номер апартамента');
            fetch(`${SCRIPT_URL}?action=get_meters&apt=${currentApt}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) return showAlert(data.error);
                    if (data.duplicate) {
                        showDuplicateModal();
                    } else {
                        meters = data.meters;
                        renderMeters();
                        document.getElementById('apt-step').style.display = 'none';
                        document.getElementById('meters-step').style.display = 'block';
                        document.getElementById('apt-title').textContent = `Апартамент №${currentApt}`;
                    }
                })
                .catch(err => showAlert('Ошибка загрузки: ' + err));
        }

        function renderMeters() {
            const container = document.getElementById('meters-container');
            container.innerHTML = '';
            meters.forEach(meter => {
                const key = `${meter.type}_${meter.number}`;
                readings[key] = ''; // Инициализация
                const div = document.createElement('div');
                div.className = 'meter-row';
                div.innerHTML = `
                    <div class="meter-info">${meter.type} ${meter.number}</div>
                    <input type="number" placeholder="Показания" onchange="updateReading('${key}', this.value)" step="0.01">
                    <label class="photo-upload">Фото (опционально): <input type="file" accept="image/*" onchange="updatePhoto('${key}', this.files[0])"></label>
                `;
                container.appendChild(div);
            });
        }

        function updateReading(key, value) {
            readings[key] = value;
        }

        function updatePhoto(key, file) {
            photos[key] = file;
        }

        function confirmSubmission() {
            const text = `Апартамент №${currentApt}<br>Показания:<br>` + Object.entries(readings).filter(([k, v]) => v).map(([k, v]) => `${k.split('_')[0]} ${k.split('_')[1]} = ${v}`).join('<br>');
            document.getElementById('confirm-text').innerHTML = text;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function submitReadings() {
            const formData = new FormData();
            formData.append('apt', currentApt);
            formData.append('readings', JSON.stringify(readings));
            Object.entries(photos).forEach(([key, file]) => {
                if (file) formData.append(key, file);
            });

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showAlert('Показания отправлены успешно!');
                    resetForm();
                } else {
                    showAlert(data.error || 'Ошибка отправки');
                }
            })
            .catch(err => showAlert('Ошибка: ' + err));
            closeConfirm();
        }

        // Модалки
        function showDuplicateModal() {
            document.getElementById('duplicate-modal').style.display = 'flex';
        }

        function loadExistingReadings() {
            fetch(`${SCRIPT_URL}?action=get_existing&apt=${currentApt}`)
                .then(res => res.json())
                .then(data => {
                    if (data.readings) {
                        Object.entries(data.readings).forEach(([key, value]) => {
                            readings[key] = value;
                            // Set input values
                            document.querySelector(`input[onchange="updateReading('${key}', this.value)"]`).value = value;
                        });
                    }
                    document.getElementById('duplicate-modal').style.display = 'none';
                    renderMeters(); // Re-render with values
                });
            closeConfirm();
        }

        function cancelApartment() {
            document.getElementById('duplicate-modal').style.display = 'none';
            document.getElementById('apt-number').value = '';
        }

        function showAlert(text) {
            document.getElementById('alert-text').textContent = text;
            document.getElementById('alert-modal').style.display = 'flex';
        }

        function closeAlert() {
            document.getElementById('alert-modal').style.display = 'none';
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').style.display = 'none';
        }

        function resetForm() {
            document.getElementById('apt-step').style.display = 'block';
            document.getElementById('meters-step').style.display = 'none';
            document.getElementById('apt-number').value = '';
            readings = {};
            photos = {};
            meters = [];
        }

        // Init
        document.getElementById('apt-number').focus();
    </script>
</body>
</html>
```
