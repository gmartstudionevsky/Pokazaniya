<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Подача показаний счётчиков | ARTSTUDIO Nevsky</title>
  <style>
    @font-face { font-family: 'Circe'; src: url('./fonts/circe.woff2') format('woff2'); font-weight: 400; }
    :root { --brand:#c49a5f; --brand-dark:#a47f48; --text:#262d36; }
    *{box-sizing:border-box}
    body{font-family:'Circe',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:1rem;background:#fff;color:var(--text)}
    body.modal-open{overflow:hidden;height:100vh}
    header{text-align:center;margin-bottom:2rem}
    main{max-width:680px;margin:0 auto;background:#fff;padding:2rem;border-radius:1rem;box-shadow:0 4px 10px rgba(0,0,0,.08)}
    .form-section{margin-bottom:1.5rem}
    .form-section h2{font-size:1.35rem;font-weight:500;margin:0 0 .5rem}
    input[type="number"], input[type="text"], button{width:100%;padding:.75rem;border:1px solid #d4d7dc;border-radius:.6rem;font:1rem 'Circe',sans-serif}
    input[type="number"]:focus, input[type="text"]:focus{outline:none;border-color:var(--brand)}
    button{background:var(--brand);color:#fff;font-weight:700;border:none;cursor:pointer;transition:background .2s}
    button:hover{background:var(--brand-dark)}
    .hint{font-size:.9rem;color:#5e6773;margin-top:.5rem}
    .meter-row{display:flex;flex-direction:column;gap:.5rem;margin-bottom:1rem;padding:1rem;background:#f7f8fa;border:1px solid #eceff3;border-radius:.6rem}
    .meter-info{font-weight:700}
    .row-two{display:flex;gap:.6rem}
    .row-two > *{flex:1}
    .photo-upload input[type="file"]{display:none}
    .photo-upload .file-btn{display:inline-block;width:100%;padding:.7rem;background:var(--brand);color:#fff;border-radius:.6rem;cursor:pointer;text-align:center;font-weight:700}
    .file-name{font-size:.85rem;color:#5e6773;margin-top:.25rem}
    .toolbar{display:flex;gap:.6rem;margin-top:1rem}
    .toolbar button{flex:1}
    .muted{opacity:.7}
    /* Modals */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999;padding:1rem}
    .modal-window{background:#fff;padding:1.5rem 1.25rem;border-radius:1rem;max-width:520px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,.2);animation:fade .2s ease-out}
    .modal-window h3{margin:.25rem 0 1rem;font-weight:700}
    .modal-window p{margin:.25rem 0 1rem;line-height:1.45}
    .modal-actions{display:flex;gap:.6rem}
    .modal-actions button{flex:1}
    @keyframes fade{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
    /* Mobile */
    @media (max-width:640px){
      main{padding:1rem}
      .row-two{flex-direction:column}
    }
  </style>
</head>
<body>
  <header>
    <h1>Подача показаний счётчиков</h1>
  </header>

  <main>
    <!-- Шаг 1 -->
    <div id="apt-step">
      <div class="form-section">
        <h2>Введите номер апартамента</h2>
        <input type="text" id="apt-number" inputmode="numeric" pattern="[0-9]*" placeholder="Например, 246" autocomplete="one-time-code" required />
        <div class="toolbar">
          <button id="btn-load">Загрузить счётчики</button>
        </div>
        <div class="hint">После загрузки появятся приборы для ввода показаний. Если показания уже подавались в этом периоде — предложим их скорректировать.</div>
      </div>
    </div>

    <!-- Шаг 2 -->
    <div id="meters-step" style="display:none">
      <h2 id="apt-title">Апартамент №</h2>
      <form id="readings-form" novalidate>
        <div id="meters-container"></div>
        <div class="toolbar">
          <button type="button" id="btn-send">Отправить показания</button>
          <button type="button" class="muted" id="btn-back">Назад</button>
        </div>
      </form>
    </div>
  </main>

  <!-- Модалка дубликатов -->
  <div id="duplicate-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true">
      <h3>Показания уже поданы</h3>
      <p>Для этого апартамента показания за текущий период уже есть. Показать и скорректировать текущие значения?</p>
      <div class="modal-actions">
        <button id="btn-correct">Скорректировать</button>
        <button id="btn-cancel-apt" class="muted">Отмена</button>
      </div>
    </div>
  </div>

  <!-- Модалка подтверждения -->
  <div id="confirm-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-window" role="dialog" aria-modal="true">
      <h3>Подтвердите отправку</h3>
      <p id="confirm-text"></p>
      <div class="modal-actions">
        <button id="btn-confirm">Подтвердить</button>
        <button id="btn-decline" class="muted">Отмена</button>
      </div>
    </div>
  </div>

  <!-- Модалка алерта -->
  <div id="alert-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-window" role="alertdialog" aria-modal="true">
      <h3>Сообщение</h3>
      <p id="alert-text"></p>
      <div class="modal-actions">
        <button id="btn-ok">OK</button>
      </div>
    </div>
  </div>

  <script>
    // === Конфиг ===
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5Vp_bf1QwDJLDTS5cX0pbcGlY_EwMf2C4CwNla7-EGulDeHPTuucejZFRkXtlWN3JLQ/exec';

    // === Состояние ===
    let currentApt = '';
    let meters = [];               // [{type, number}]
    const readings = Object.create(null); // { 'Type_Number': '12.34' }
    const photos   = Object.create(null); // { 'Type_Number': dataURL }

    // === DOM ===
    const aptInput = document.getElementById('apt-number');
    const btnLoad = document.getElementById('btn-load');
    const btnSend = document.getElementById('btn-send');
    const btnBack = document.getElementById('btn-back');

    const aptStep = document.getElementById('apt-step');
    const metersStep = document.getElementById('meters-step');
    const aptTitle = document.getElementById('apt-title');
    const metersContainer = document.getElementById('meters-container');

    const duplicateModal = document.getElementById('duplicate-modal');
    const btnCorrect = document.getElementById('btn-correct');
    const btnCancelApt = document.getElementById('btn-cancel-apt');

    const confirmModal = document.getElementById('confirm-modal');
    const confirmText = document.getElementById('confirm-text');
    const btnConfirm = document.getElementById('btn-confirm');
    const btnDecline = document.getElementById('btn-decline');

    const alertModal = document.getElementById('alert-modal');
    const alertText = document.getElementById('alert-text');
    const btnOk = document.getElementById('btn-ok');

    // === Утилиты UI ===
    function openModal(el){ document.body.classList.add('modal-open'); el.style.display = 'flex'; }
    function closeModal(el){ el.style.display = 'none'; document.body.classList.remove('modal-open'); }
    function showAlert(msg){ alertText.textContent = msg; openModal(alertModal); }

    function sanitizeApt(val) {
      // оставим только цифры
      return String(val).replace(/\D+/g,'').trim();
    }

    function normalizeNumberInput(v) {
      // заменяем запятую на точку; допускаем пустое значение
      if (v === null || v === undefined) return '';
      const s = String(v).trim().replace(',', '.');
      return s;
    }

    // === Рендер приборов ===
    function renderMeters() {
      metersContainer.innerHTML = '';
      if (!Array.isArray(meters) || meters.length === 0) return;

      meters.forEach(m => {
        const key = `${m.type}_${m.number}`;
        if (!(key in readings)) readings[key] = '';

        const row = document.createElement('div');
        row.className = 'meter-row';

        const info = document.createElement('div');
        info.className = 'meter-info';
        info.textContent = `${m.type} ${m.number}`;
        row.appendChild(info);

        const two = document.createElement('div');
        two.className = 'row-two';

        const numInput = document.createElement('input');
        numInput.type = 'number';
        numInput.step = '0.01';
        numInput.placeholder = 'Показания';
        numInput.value = readings[key] ?? '';
        numInput.dataset.key = key;
        numInput.inputMode = 'decimal';
        numInput.addEventListener('input', (e) => {
          const val = normalizeNumberInput(e.target.value);
          readings[key] = val;
        });

        const photoWrap = document.createElement('div');
        photoWrap.className = 'photo-upload';
        const fileId = `file_${key.replace(/[^a-zA-Z0-9]/g,'_')}`;

        const label = document.createElement('label');
        label.className = 'file-btn';
        label.htmlFor = fileId;
        label.textContent = 'Добавить фото';

        const file = document.createElement('input');
        file.type = 'file';
        file.accept = 'image/*;capture=environment';
        file.id = fileId;
        file.addEventListener('change', async (e) => {
          const f = e.target.files && e.target.files[0];
          if (!f) return;
          try {
            const dataUrl = await resizeToDataURL(f, 1600, 0.85); // сжимаем до разумного размера
            photos[key] = dataUrl;
            nameEl.textContent = f.name + ' ✓';
          } catch (err) {
            console.error(err);
            showAlert('Не удалось обработать фото: ' + err.message);
          }
        });

        const nameEl = document.createElement('div');
        nameEl.className = 'file-name';
        nameEl.textContent = photos[key] ? 'Фото прикреплено ✓' : '';

        photoWrap.appendChild(label);
        photoWrap.appendChild(file);
        photoWrap.appendChild(nameEl);

        two.appendChild(numInput);
        two.appendChild(photoWrap);
        row.appendChild(two);

        metersContainer.appendChild(row);
      });
    }

    // === Загрузка приборов ===
    async function loadMeters() {
      const aptRaw = sanitizeApt(aptInput.value);
      if (!aptRaw) return showAlert('Введите номер апартамента');
      currentApt = aptRaw;

      btnLoad.disabled = true;
      btnLoad.textContent = 'Загрузка…';
      try {
        const res = await fetch(`${SCRIPT_URL}?action=get_meters&apt=${encodeURIComponent(currentApt)}`, {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        meters = data.meters || [];
        if (!meters.length) return showAlert(`Счётчики для №${currentApt} не найдены`);

        if (data.duplicate) {
          // Показать модалку, но приборы уже знаем — сможем отрисовать и префиллить
          openModal(duplicateModal);
        } else {
          // Сразу к вводу
          aptStep.style.display = 'none';
          metersStep.style.display = 'block';
          aptTitle.textContent = `Апартамент №${currentApt}`;
          renderMeters();
        }
      } catch (err) {
        console.error(err);
        showAlert('Ошибка загрузки: ' + err.message);
      } finally {
        btnLoad.disabled = false;
        btnLoad.textContent = 'Загрузить счётчики';
      }
    }

    // === Подтянуть текущие показания при дубликате ===
    async function loadExistingReadings() {
      try {
        // сначала отрисуем поля
        aptStep.style.display = 'none';
        metersStep.style.display = 'block';
        aptTitle.textContent = `Апартамент №${currentApt}`;
        renderMeters();

        const res = await fetch(`${SCRIPT_URL}?action=get_existing&apt=${encodeURIComponent(currentApt)}`, {
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (data && data.readings) {
          for (const [key, value] of Object.entries(data.readings)) {
            readings[key] = String(value);
            const input = metersContainer.querySelector(`input[data-key="${CSS.escape(key)}"]`);
            if (input) input.value = readings[key];
          }
        }
      } catch (err) {
        console.error(err);
        showAlert('Ошибка загрузки существующих: ' + err.message);
      } finally {
        closeModal(duplicateModal);
      }
    }

    // === Подтверждение и отправка ===
    function confirmSubmission() {
      // Проверяем, что есть хотя бы одно заполненное значение
      const filled = Object.entries(readings)
        .filter(([k,v]) => v !== '' && v !== null && v !== undefined)
        .map(([k,v]) => {
          const [t,n] = k.split('_');
          return `${t} ${n} = ${v}`;
        });

      if (filled.length === 0) {
        showAlert('Введите хотя бы одно показание');
        return;
      }

      confirmText.innerHTML =
        `Апартамент №${currentApt}<br>Показания:<br>` +
        filled.join('<br>');
      openModal(confirmModal);
    }

    async function submitReadings() {
      // слей фото в объект readings как *_photo
      const payloadReadings = {};
      // копируем только ключи, которые относятся к текущим приборам
      meters.forEach(m => {
        const key = `${m.type}_${m.number}`;
        if (readings[key] !== undefined && readings[key] !== '') {
          payloadReadings[key] = normalizeNumberInput(readings[key]);
        }
        if (photos[key]) {
          payloadReadings[key + '_photo'] = photos[key];
        }
      });

      btnSend.disabled = true;
      btnSend.textContent = 'Отправка…';
      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ apt: currentApt, readings: payloadReadings })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Неизвестная ошибка');

        showAlert('Показания отправлены успешно!');
        resetForm();
      } catch (err) {
        console.error(err);
        showAlert('Ошибка отправки: ' + err.message);
      } finally {
        btnSend.disabled = false;
        btnSend.textContent = 'Отправить показания';
        closeModal(confirmModal);
      }
    }

    function resetForm() {
      currentApt = '';
      meters = [];
      for (const k of Object.keys(readings)) delete readings[k];
      for (const k of Object.keys(photos)) delete photos[k];

      aptInput.value = '';
      aptStep.style.display = 'block';
      metersStep.style.display = 'none';
      metersContainer.innerHTML = '';
      aptInput.focus();
    }

    // === Работа с изображением (сжатие) ===
    function resizeToDataURL(file, maxSize = 1600, quality = 0.85) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('Не удалось прочитать файл'));
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            const { width, height } = img;
            let targetW = width;
            let targetH = height;
            if (width > height && width > maxSize) {
              targetW = maxSize; targetH = Math.round(height * (maxSize / width));
            } else if (height >= width && height > maxSize) {
              targetH = maxSize; targetW = Math.round(width * (maxSize / height));
            }
            const canvas = document.createElement('canvas');
            canvas.width = targetW;
            canvas.height = targetH;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, targetW, targetH);
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(dataUrl);
          };
          img.onerror = () => reject(new Error('Не удалось декодировать изображение'));
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // === Слушатели ===
    btnLoad.addEventListener('click', loadMeters);
    aptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') loadMeters(); });

    btnBack.addEventListener('click', () => {
      metersStep.style.display = 'none';
      aptStep.style.display = 'block';
    });

    btnSend.addEventListener('click', confirmSubmission);
    btnConfirm.addEventListener('click', submitReadings);
    btnDecline.addEventListener('click', () => closeModal(confirmModal));
    btnOk.addEventListener('click', () => closeModal(alertModal));

    btnCorrect.addEventListener('click', loadExistingReadings);
    btnCancelApt.addEventListener('click', () => { closeModal(duplicateModal); aptInput.value = ''; });

    // фокус на поле апартамента при загрузке
    window.addEventListener('DOMContentLoaded', () => aptInput.focus());
  </script>
</body>
</html>
