<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Подача показаний счётчиков | ARTSTUDIO Nevsky</title>
    <style>
        /* Circe fonts */
        @font-face { font-family: 'Circe'; src: url('./fonts/circe.woff2') format('woff2'); font-weight: 400; }
        /* Base styles */
        :root { --brand: #c49a5f; --brand-dark: #a47f48; --text: #262d36; }
        body { font-family: 'Circe', sans-serif; margin: 0; padding: 1rem; background: #fff; color: var(--text); }
        header { text-align: center; margin-bottom: 2rem; }
        main { max-width: 600px; margin: 0 auto; background: #fff; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .form-section { margin-bottom: 1.5rem; }
        .form-section h2 { font-size: 1.5rem; font-weight: 400; margin: 0 0 0.5rem; }
        input[type="number"], button { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 0.5rem; font: 1rem 'Circe', sans-serif; box-sizing: border-box; }
        button { background: var(--brand); color: #fff; font-weight: 700; border: none; cursor: pointer; transition: background 0.3s; }
        button:hover { background: var(--brand-dark); }
        /* Стилизованный file input */
        .photo-upload { margin-top: 0.5rem; }
        .photo-upload input[type="file"] { display: none; } /* Скрыть системный input */
        .photo-upload label { display: inline-block; width: 100%; padding: 0.75rem; background: var(--brand); color: #fff; border-radius: 0.5rem; cursor: pointer; text-align: center; font-weight: 600; transition: background 0.3s; }
        .photo-upload label:hover { background: var(--brand-dark); }
        /* Модалки — улучшены для overlay поверх всего */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 10000; height: 100vh; } /* height: 100vh для полного покрытия */
        .modal-window { background: #fff; padding: 2rem; border-radius: 1.5rem; max-width: 90%; max-height: 80vh; overflow-y: auto; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2); animation: modalFadeIn 0.3s ease-out; }
        .modal-window p { font-size: 1.1rem; margin: 0 auto 1rem; text-align: left; }
        .modal-actions { display: flex; gap: 1rem; justify-content: center; margin-top: 1rem; }
        .modal-actions button { width: auto; padding: 0.75rem 2rem; flex: 1; max-width: 150px; }
        @keyframes modalFadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .meter-row { display: flex; flex-direction: column; margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 0.5rem; }
        .meter-info { font-weight: 600; margin-bottom: 0.5rem; }
        /* Mobile */
        @media (max-width: 600px) { main { padding: 1rem; } input, button { padding: 0.5rem; font-size: 0.95rem; } .modal-actions { flex-direction: column; gap: 0.5rem; } }
    </style>
</head>
<body>
    <header>
        <h1>Подача показаний счётчиков</h1>
    </header>
    <main>
        <!-- Шаг 1: Ввод номера апартамента -->
        <div id="apt-step">
            <div class="form-section">
                <h2>Введите номер апартамента</h2>
                <input type="number" id="apt-number" placeholder="Например, 246" min="1" required>
                <button onclick="loadMeters()">Загрузить счётчики</button>
            </div>
        </div>
        <!-- Шаг 2: Ввод показаний -->
        <div id="meters-step" style="display: none;">
            <h2 id="apt-title">Апартамент №</h2>
            <form id="readings-form">
                <div id="meters-container"></div>
                <button type="button" onclick="confirmSubmission()">Отправить показания</button>
            </form>
        </div>
    </main>
    <!-- Модалка дубликатов -->
    <div id="duplicate-modal" class="modal-overlay" style="display: none;">
        <div class="modal-window">
            <p>По апартаменту показания уже поданы за период. Показать текущие?</p>
            <div class="modal-actions">
                <button onclick="loadExistingReadings()">Скорректировать</button>
                <button onclick="cancelApartment()">Отмена</button>
            </div>
        </div>
    </div>
    <!-- Модалка подтверждения -->
    <div id="confirm-modal" class="modal-overlay" style="display: none;">
        <div class="modal-window">
            <p id="confirm-text"></p>
            <div class="modal-actions">
                <button onclick="submitReadings()">Подтвердить</button>
                <button onclick="closeConfirm()">Отмена</button>
            </div>
        </div>
    </div>
    <!-- Модалка ошибки/успеха -->
    <div id="alert-modal" class="modal-overlay" style="display: none;">
        <div class="modal-window">
            <p id="alert-text"></p>
            <div class="modal-actions">
                <button onclick="closeAlert()">OK</button>
            </div>
        </div>
    </div>
    <script>
        let currentApt = '';
        let meters = [];
        let readings = {}; // { 'type_number': value }
        let photos = {}; // { 'type_number': base64 }
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxbjAwdfq0M35WhRhgPzLIAZ7KL6ye-PQYNFYxVzgs4nug7r3zEQF2ChumX4grGPGThDA/exec'; // Ваш URL

        function loadMeters() {
            currentApt = document.getElementById('apt-number').value.trim();
            if (!currentApt) return showAlert('Введите номер апартамента');
            fetch(`${SCRIPT_URL}?action=get_meters&apt=${currentApt}`)
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    return res.json();
                })
                .then(data => {
                    if (data.error) return showAlert(data.error);
                    if (data.duplicate) {
                        showDuplicateModal();
                    } else {
                        meters = data.meters;
                        renderMeters();
                        document.getElementById('apt-step').style.display = 'none';
                        document.getElementById('meters-step').style.display = 'block';
                        document.getElementById('apt-title').textContent = `Апартамент №${currentApt}`;
                    }
                })
                .catch(err => {
                    console.error('Fetch error:', err); // Для отладки
                    showAlert('Ошибка загрузки: ' + err.message);
                });
        }

        function renderMeters() {
            const container = document.getElementById('meters-container');
            container.innerHTML = '';
            meters.forEach(meter => {
                const key = `${meter.type}_${meter.number}`;
                readings[key] = ''; // Инициализация
                const div = document.createElement('div');
                div.className = 'meter-row';
                div.innerHTML = `
                    <div class="meter-info">${meter.type} ${meter.number}</div>
                    <input type="number" placeholder="Показания" onchange="updateReading('${key}', this.value)" step="0.01">
                    <label class="photo-upload">Фото (опционально): <input type="file" accept="image/*" onchange="updatePhoto('${key}', this.files[0])"></label>
                `;
                container.appendChild(div);
            });
        }

        function updateReading(key, value) {
            readings[key] = value;
        }

        function updatePhoto(key, files) {
            const file = files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) return showAlert('Фото слишком большое (>5MB)');
            const reader = new FileReader();
            reader.onload = (e) => {
                photos[key] = e.target.result; // base64
            };
            reader.readAsDataURL(file);
        }

        function confirmSubmission() {
            const text = `Апартамент №${currentApt}<br>Показания:<br>` + Object.entries(readings).filter(([k, v]) => v).map(([k, v]) => `${k.split('_')[0]} ${k.split('_')[1]} = ${v}`).join('<br>');
            document.getElementById('confirm-text').innerHTML = text;
            document.body.style.overflow = 'hidden'; // Блокируем скролл
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function submitReadings() {
            // Добавить base64 фото в readings
            Object.keys(readings).forEach(key => {
                if (photos[key]) readings[key + '_photo'] = photos[key];
            });
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ apt: currentApt, readings: readings })
            })
            .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    showAlert('Показания отправлены успешно!');
                    resetForm();
                } else {
                    showAlert(data.error || 'Ошибка отправки');
                }
            })
            .catch(err => {
                console.error('Fetch error:', err); // Для отладки
                showAlert('Ошибка отправки: ' + err.message);
            });
            closeConfirm();
        }

        // Модалки
        function showDuplicateModal() {
            document.body.style.overflow = 'hidden';
            document.getElementById('duplicate-modal').style.display = 'flex';
        }

        function loadExistingReadings() {
            fetch(`${SCRIPT_URL}?action=get_existing&apt=${currentApt}`)
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    return res.json();
                })
                .then(data => {
                    if (data.readings) {
                        Object.entries(data.readings).forEach(([key, value]) => {
                            readings[key] = value;
                            const input = document.querySelector(`input[onchange="updateReading('${key}', this.value)"]`);
                            if (input) input.value = value;
                        });
                    }
                    document.getElementById('duplicate-modal').style.display = 'none';
                    document.body.style.overflow = 'auto';
                    renderMeters(); // Re-render with values
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    showAlert('Ошибка загрузки существующих: ' + err.message);
                });
        }

        function cancelApartment() {
            document.getElementById('duplicate-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('apt-number').value = '';
        }

        function showAlert(text) {
            document.body.style.overflow = 'hidden';
            document.getElementById('alert-text').textContent = text;
            document.getElementById('alert-modal').style.display = 'flex';
        }

        function closeAlert() {
            document.getElementById('alert-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function closeConfirm() {
            document.getElementById('confirm-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function resetForm() {
            document.getElementById('apt-step').style.display = 'block';
            document.getElementById('meters-step').style.display = 'none';
            document.getElementById('apt-number').value = '';
            readings = {};
            photos = {};
            meters = [];
        }

        // Init
        document.getElementById('apt-number').focus();
    </script>
</body>
</html>
